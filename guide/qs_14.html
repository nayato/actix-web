<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Database integration - Actix web</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Actix web framework guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="./qs_1.html">Quickstart</a></li><li><a href="./qs_2.html"><strong>1.</strong> Getting Started</a></li><li><a href="./qs_3.html"><strong>2.</strong> Application</a></li><li><a href="./qs_3_5.html"><strong>3.</strong> Server</a></li><li><a href="./qs_4.html"><strong>4.</strong> Handler</a></li><li><a href="./qs_4_5.html"><strong>5.</strong> Errors</a></li><li><a href="./qs_5.html"><strong>6.</strong> URL Dispatch</a></li><li><a href="./qs_7.html"><strong>7.</strong> Request &amp; Response</a></li><li><a href="./qs_8.html"><strong>8.</strong> Testing</a></li><li><a href="./qs_10.html"><strong>9.</strong> Middlewares</a></li><li><a href="./qs_12.html"><strong>10.</strong> Static file handling</a></li><li><a href="./qs_9.html"><strong>11.</strong> WebSockets</a></li><li><a href="./qs_13.html"><strong>12.</strong> HTTP/2</a></li><li><a href="./qs_14.html" class="active"><strong>13.</strong> Database integration</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Actix web</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./qs_14.html#database-integration" id="database-integration"><h1>Database integration</h1></a>
<a class="header" href="./qs_14.html#diesel" id="diesel"><h2>Diesel</h2></a>
<p>At the moment of 1.0 release Diesel does not support asynchronous operations.
But it possible to use <code>actix</code> synchronous actor system as a db interface api.
Technically sync actors are worker style actors, multiple of them
can be run in parallel and process messages from same queue (sync actors work in mpmc mode).</p>
<p>Let's create simple db api that can insert new user row into sqlite table.
We have to define sync actor and connection that this actor will use. Same approach
could used for other databases.</p>
<pre><code class="language-rust ignore">use actix::prelude::*;*

struct DbExecutor(SqliteConnection);

impl Actor for DbExecutor {
    type Context = SyncContext&lt;Self&gt;;
}
</code></pre>
<p>This is definition of our actor. Now we need to define <em>create user</em> message and response.</p>
<pre><code class="language-rust ignore">#[derive(Message)]
#[rtype(User, Error)]
struct CreateUser {
    name: String,
}
</code></pre>
<p>We can send <code>CreateUser</code> message to <code>DbExecutor</code> actor, and as result we get
<code>User</code> model. Now we need to define actual handler implementation for this message.</p>
<pre><code class="language-rust ignore">impl Handler&lt;CreateUser&gt; for DbExecutor {

    fn handle(&amp;mut self, msg: CreateUser, _: &amp;mut Self::Context) -&gt; Response&lt;Self, CreateUser&gt;
    {
        use self::schema::users::dsl::*;

        // Create insertion model
        let uuid = format!(&quot;{}&quot;, uuid::Uuid::new_v4());
        let new_user = models::NewUser {
            id: &amp;uuid,
            name: &amp;msg.name,
        };

        // normal diesl operations
        diesel::insert_into(users)
            .values(&amp;new_user)
            .execute(&amp;self.0)
            .expect(&quot;Error inserting person&quot;);

        let mut items = users
            .filter(id.eq(&amp;uuid))
            .load::&lt;models::User&gt;(&amp;self.0)
            .expect(&quot;Error loading person&quot;);

        Self::reply(items.pop().unwrap())
    }
}
</code></pre>
<p>That is it. Now we can use <em>DbExecutor</em> actor from any http handler or middleware.
All we need is to start <em>DbExecutor</em> actors and store address in a state where http handler
can access it.</p>
<pre><code class="language-rust ignore">/// This is state where we will store *DbExecutor* address.
struct State {
    db: SyncAddress&lt;DbExecutor&gt;,
}

fn main() {
    let sys = actix::System::new(&quot;diesel-example&quot;);

    // Start 3 parallele db executors
    let addr = SyncArbiter::start(3, || {
        DbExecutor(SqliteConnection::establish(&quot;test.db&quot;).unwrap())
    });

    // Start http server
    HttpServer::new(move || {
        Application::with_state(State{db: addr.clone()})
            .resource(&quot;/{name}&quot;, |r| r.method(Method::GET).a(index))})
        .bind(&quot;127.0.0.1:8080&quot;).unwrap()
        .start().unwrap();

    println!(&quot;Started http server: 127.0.0.1:8080&quot;);
    let _ = sys.run();
}
</code></pre>
<p>And finally we can use address in a requst handler. We get message response
asynchronously, so handler needs to return future object, also <code>Route::a()</code> needs to be
used for async handler registration.</p>
<pre><code class="language-rust ignore">/// Async handler
fn index(req: HttpRequest&lt;State&gt;) -&gt; Box&lt;Future&lt;Item=HttpResponse, Error=Error&gt;&gt; {
    let name = &amp;req.match_info()[&quot;name&quot;];

    // Send message to `DbExecutor` actor
    req.state().db.call_fut(CreateUser{name: name.to_owned()})
        .from_err()
        .and_then(|res| {
            match res {
                Ok(user) =&gt; Ok(httpcodes::HTTPOk.build().json(user)?),
                Err(_) =&gt; Ok(httpcodes::HTTPInternalServerError.into())
            }
        })
        .responder()
}
</code></pre>
<p>Full example is available in
<a href="https://github.com/actix/actix-web/tree/master/examples/diesel/">examples directory</a>.</p>
<p>More information on sync actors could be found in
<a href="https://docs.rs/actix/0.3.3/actix/sync/index.html">actix documentation</a>.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./qs_13.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                

            </div>

            
                <a href="./qs_13.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        
        <!-- Google Analytics Tag -->
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is 
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-110322332-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
